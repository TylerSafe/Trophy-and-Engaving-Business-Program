import tkinter as tk
import tkinter.ttk as ttk
from tkinter import *
import os
from openpyxl import load_workbook
from PIL import Image, ImageDraw, ImageGrab

PATH = os.path.abspath(".") # path to the folder containing the python file
FONT = 'GoogleSans 11' # font used throughout the application
ENTRY_COLOUR = '#6e6d6d' # colour of entry field text

# class that loads the initial window and handles styles/interactions
class Window:
    def __init__(self, master):
        frame = Frame(master, bg='white')

        # load classes
        self.cus_search = CustomerDetails(frame, self)
        self.cus_history = CustomerHistory(frame)
        self.signature = Signature(frame)
        self.sheet = JobSheets(frame)

        # create heading
        self.heading = PhotoImage(file=PATH + '\\Resources\\Images\\heading_image.png')
        self.heading_label = Label(frame, image=self.heading, border=0)
        self.heading_label.grid(row=0, column=1, padx=5, pady=0, rowspan=2, columnspan=2, sticky=N)
        
        frame.grid()

    # create error message window
    def error_message(self, message):
        self.error = Toplevel()
        self.error.title('Error')
        self.error.geometry('')
        self.error.configure(background='white')
        self.error.iconbitmap(PATH + '\\Resources\\Images\\logo.ico')

        self.error_image = PhotoImage(file=PATH + '\\Resources\\Images\\error_cross.png')
        self.error_cross = Label(self.error, image=self.error_image, border=0)
        self.error_cross.grid(row=0, column=0, padx=(15, 0), pady=15, sticky=E)
        self.error_label = Label(self.error, text=message, font=FONT, bg='white')
        self.error_label.grid(row=0, column=1, padx=(5, 15), pady=(15, 15), sticky=W)

        self.button_image = PhotoImage(file=PATH + '\\Resources\\Images\\button_ok.png')
        self.error_button = Button(self.error, image=self.button_image, command=self.error.destroy, border=0, bg='white', highlightthickness=0)

        self.error_button.grid(row=1, column=0, columnspan=2, padx=10, pady=(5, 15), sticky=N)

        self.error.attributes('-topmost', 'true')
        self.center(self.error)

    # create confirmation message window
    def confirm_message(self, message):
        self.confirm = Toplevel()
        self.confirm.title('Confirmation')
        self.confirm.geometry('')
        self.confirm.configure(background='white')
        self.confirm.iconbitmap(PATH + '\\Resources\\Images\\logo.ico')

        self.confirm_image = PhotoImage(file=PATH + '\\Resources\\Images\\confirm_tick.png')
        self.confirm_tick = Label(self.confirm, image=self.confirm_image, border=0)
        self.confirm_tick.grid(row=0, column=0, padx=(15, 0), pady=15, sticky=E)
        self.confirm_label = Label(self.confirm, text=message, font=FONT, bg='white')
        self.confirm_label.grid(row=0, column=1, padx=(5, 15), pady=(15, 15), sticky=W)

        self.button_image = PhotoImage(file=PATH + '\\Resources\\Images\\button_ok.png')
        self.confirm_button = Button(self.confirm, image=self.button_image, command=self.confirm.destroy, border=0, bg='white', highlightthickness=0)

        self.confirm_button.grid(row=1, column=0, columnspan=2, padx=10, pady=(5, 15), sticky=N)

        self.confirm.attributes('-topmost', 'true')
        self.center(self.confirm)

    # give the customer a choice between two options (ok/cancel)
    def option_message(self, message, function):
        self.option = Toplevel()
        self.option.title('Confirmation')
        self.option.geometry('')
        self.option.configure(background='white')
        self.option.iconbitmap(PATH + '\\Resources\\Images\\logo.ico')

        self.option_label = Label(self.option, text=message, font=FONT, bg='white')
        self.option_label.grid(row=0, column=0, padx=(15, 15), pady=15, columnspan=2, sticky=W)

        self.button_ok = PhotoImage(file=PATH + '\\Resources\\Images\\button_ok.png')
        if function == 'delete':
            self.ok_button = Button(self.option, image=self.button_ok, command=lambda:(self.cus_search.del_cus(), self.option.destroy()), border=0, bg='white', highlightthickness=0)
        elif function == 'edit':
            self.ok_button = Button(self.option, image=self.button_ok, command=lambda:(self.cus_search.edit_cus(), self.option.destroy()), border=0, bg='white', highlightthickness=0)
        self.ok_button.grid(row=1, column=0, padx=(0,10), pady=(5, 15), sticky=E)

        self.button_cancel = PhotoImage(file=PATH + '\\Resources\\Images\\button_cancel.png')
        self.cancel_button = Button(self.option, image=self.button_cancel, command=self.option.destroy, border=0, bg='white', highlightthickness=0)
        self.cancel_button.grid(row=1, column=1, padx=(10,0), pady=(5, 15), sticky=W)

        self.option.attributes('-topmost', 'true')
        self.center(self.option)

    # center any windows that pop up on the screen
    def center(self, win):
        win.update_idletasks()
        width = win.winfo_width()
        frm_width = win.winfo_rootx() - win.winfo_x()
        win_width = width + 2 * frm_width
        height = win.winfo_height()
        titlebar_height = win.winfo_rooty() - win.winfo_y()
        win_height = height + titlebar_height + frm_width
        x = win.winfo_screenwidth() // 2 - win_width // 2
        y = win.winfo_screenheight() // 2 - win_height // 2
        win.geometry('{}x{}+{}+{}'.format(width, height, x, y))
        win.deiconify()  

# class that generates fields for different job sheets
class JobSheets:
    def __init__(self, frame):
        # button that creates the trophy sheet entries/labels
        self.button_trophy = PhotoImage(file=PATH + '\\Resources\\Images\\trophy_sheet.png')
        self.trophy_button = Button(frame, image=self.button_trophy, command=self.trophy_sheet, border=0, bg='white', highlightthickness=0)
        self.trophy_button.grid(row=2, column=1, padx=(10,20), pady=(10, 0), sticky=W)

        # button that creates the engraving sheet entries/labels
        self.button_engraving = PhotoImage(file=PATH + '\\Resources\\Images\\engraving_sheet.png')
        self.engraving_button = Button(frame, image=self.button_engraving, command=self.engraving_sheet, border=0, bg='white', highlightthickness=0)
        self.engraving_button.grid(row=2, column=2, padx=(0,0), pady=(10, 0), sticky=W)

    def trophy_sheet(self):
        print('trophy sheet')

    def engraving_sheet(self):
        print('engraving sheet')


# class that handles all signature field functionality,
class Signature:
    def __init__(self, frame):
        # impletement signature field
        self.signature(frame)

        # signature heading
        self.sig_label = Label(frame, text='Signature', font='GoogleSans 12 bold', bg='white', fg='#858585')
        self.sig_label.grid(row=0, column=3, padx=(50,0), pady=(10, 0), sticky=NW)
        
        # save a copy of the signature to the resources folder
        #confirm_button = Button(frame ,text='Confirm', width=10, bg='#e1e5eb', command=self.img.save(PATH + '\\Resources\\Images\\signature.png'))
        #confirm_button.grid(row=2, column=2, padx=(0,20), pady=(10, 0))
        
    # create signature field and implement functionality
    def signature(self, frame):    
        # image to make signature field look nice
        self.sig_field_image = PhotoImage(file=PATH + '\\Resources\\Images\\signature_field.png')
        self.sig_field_label = Label(frame, image=self.sig_field_image, border=0)
        self.sig_field_label.grid(row=0, column=3, padx=(50,20), pady=(39, 0), rowspan=2, sticky=NW)
        
        # actual signature field that is written on
        w = Canvas(frame, bg = 'white', highlightthickness=0, width=285, height = 105, name='signature field')
        w.grid(row=0, column=3, padx=(58,20), pady=(49, 0), rowspan=2, sticky=NW)
        self.img = Image.new('RGB',(285,105), (255, 255, 255))
        draw = ImageDraw.Draw(self.img)

        self.mousePressed = False
        self.last=None

        # mouse events
        def press(evt):
            self.mousePressed = True
        def release(evt):
            self.mousePressed = False

        w.bind_all('<ButtonPress-1>', press)
        w.bind_all('<ButtonRelease-1>', release)
            
        def move(evt):
            # get the position of the mouse
            x,y = frame.winfo_pointerxy()
            widget = frame.winfo_containing(x,y)
            # check if the mouse is in the signature field
            if str(widget) == '.!frame.signature field':
                # track mouse events to get customer signature
                x,y = evt.x,evt.y
                try:
                    if self.mousePressed:
                        if self.last is None:
                            self.last = (x,y)
                            return
                        draw.line(((x,y),self.last), (0,0,0))
                        w.create_line(x,y,self.last[0],self.last[1])
                        self.last = (x,y)
                    else:
                        self.last = (x,y)
                except:
                    pass

        w.bind_all('<Motion>', move)


# class that handles display and saving of previous customer orders, including autofill
class CustomerHistory:
    def __init__(self, frame):
        self.history = Label(frame, text='Previous Orders', font='GoogleSans 12 bold', bg='white', fg='#858585')
        self.history.grid(row=14, column=0, padx=20, pady=(5, 0), sticky=NW)


# class that handles searching customers by name, retrieving information, creating new customers, deleting customers, and updating customer information
class CustomerDetails:
    def __init__(self, frame, window):
        # load all customer names from excel doc
        self.cus_names = []
        try:
            wb = load_workbook(PATH + '\\Resources\\Files\\GTC Customer List.xlsx')
            ws = wb['Sheet1']  
            name = ws['A']
            self.cus_names = [name[x].value for x in range(len(name))]
            del self.cus_names[0]
            wb.close()
        except:
            window.error_message('Error! Customer List Not Found')
        
        # create label for search entry
        self.search_image = PhotoImage(file=PATH + '\\Resources\\Images\\search_box.png')
        self.search_label = Label(frame, image=self.search_image, border=0)
        self.search_label.grid(row=0, column=0, padx=15, pady=(10, 0), sticky=W)
        
        # create search entry field that can be submitted by pressing enter
        self.search_entry = Entry(frame)
        self.search_entry.configure(width=32, foreground='grey', font=FONT, border=0)
        self.search_entry.insert(END, 'Search for a Customer')
        self.search_entry.bind('<KeyRelease>', self.check_listbox)
        self.search_entry.bind('<1>', self.clicked)
        self.search_entry.grid(row=0, column=0, padx=50, pady=(10, 0), sticky=W)

        # create list box to fill with autocomplete suggestions
        self.listbox = Listbox(frame, exportselection=False, border=0, width=32, height=5, font=FONT, fg='grey', highlightthickness=0)
        self.listbox.grid(row=1, column=0, padx=15, pady=0, sticky=N)
        self.listbox.bind('<<ListboxSelect>>', self.autofill)

        # add button to clear search entry
        self.clear_button = Button(frame, text='x', command=lambda:self.search_entry.delete(0, END), border=0, bg='white', fg='grey', font=FONT, highlightthickness=0)
        self.clear_button.grid(row=0, column=0, padx=53, pady=(10, 2), sticky=E)

        # create all entry fields with labels, cumbersome/lengthy code so moved out of __init__
        self.create_entries(frame)

        # create button to clear all entry fields
        self.cus_clear = PhotoImage(file=PATH + '\\Resources\\Images\\cus_clear.png')
        self.clear_button = Button(frame, image=self.cus_clear, command=self.clear_cus_entries, border=0, bg='white', highlightthickness=0)
        self.clear_button.grid(row=12, column=0, padx=(30, 0), pady=(12, 8), sticky=W)

        # create button to add new customer to database
        self.cus_add = PhotoImage(file=PATH + '\\Resources\\Images\\add_customer.png')
        self.add_button = Button(frame, image=self.cus_add, command=self.add_customer, border=0, bg='white', highlightthickness=0)
        self.add_button.grid(row=12, column=0, padx=(182, 0), pady=(12, 8), sticky=W)

        # create button to edit customer information in database
        self.cus_edit = PhotoImage(file=PATH + '\\Resources\\Images\\edit_customer.png')
        self.edit_button = Button(frame, image=self.cus_edit, command=self.edit_customer, border=0, bg='white', highlightthickness=0)
        self.edit_button.grid(row=13, column=0, padx=(30, 0), pady=(0, 5), sticky=W)

        # create button to edit customer information in database
        self.cus_del = PhotoImage(file=PATH + '\\Resources\\Images\\delete_customer.png')
        self.del_button = Button(frame, image=self.cus_del, command=self.delete_customer, border=0, bg='white', highlightthickness=0)
        self.del_button.grid(row=13, column=0, padx=(182, 0), pady=(0, 5), sticky=W)

    # checks if customer is in list and confirms edit
    def edit_customer(self):
        name = self.name_entry.get()
        if name not in self.cus_names:
            window.error_message('Error! Customer does not exist')
        else:
            window.option_message(f'Are you sure you want to change {name} information to the entered details?', 'edit')

    # get the row of the customer in the excel doc and change the values to the new values
    def edit_cus(self):
        name = self.name_entry.get()
        try:
            row = self.cus_names.index(name) + 2

            wb = load_workbook(PATH + '\\Resources\\Files\\GTC Customer List.xlsx')
            ws = wb['Sheet1']

            ws.cell(column=1, row=row, value=self.name_entry.get())
            ws.cell(column=3, row=row, value=self.address_entry.get())
            ws.cell(column=5, row=row, value=self.state_entry.get())
            ws.cell(column=4, row=row, value=self.city_entry.get())
            ws.cell(column=6, row=row, value=self.postcode_entry.get())
            ws.cell(column=7, row=row, value=self.phone_entry.get())
            ws.cell(column=8, row=row, value=self.email_entry.get())

            wb.save(PATH + '\\Resources\\Files\\GTC Customer List.xlsx')
            wb.close()
            window.confirm_message(f'{name} Information Updated')
            self.clear_cus_entries()
        except:
            window.error_message('Error! Customer List Not Found')

    # creates the message and opens option window
    def delete_customer(self):
        name = self.name_entry.get()
        if name not in self.cus_names:
            window.error_message('Error! Customer does not exist')
        else:
            window.option_message(f'Are you sure you want to delete {name} from the customer list?', 'delete')

    # deletes the customer from the excel doc
    def del_cus(self):
        name = self.name_entry.get()
        try:
            row = self.cus_names.index(name) + 2

            wb = load_workbook(PATH + '\\Resources\\Files\\GTC Customer List.xlsx')
            ws = wb['Sheet1']
            ws.delete_rows(row, 1)

            wb.save(PATH + '\\Resources\\Files\\GTC Customer List.xlsx')
            wb.close()

            self.cus_names.remove(name)

            window.confirm_message(f'Successfully deleted {name} from the customer list')
        except:
            window.error_message('Error! Customer List Not Found')

    # add customer to the excel doc and update the list of customer names
    def add_customer(self):
        # check if customer name already exists
        if self.name_entry.get() in self.cus_names:
            window.error_message('Error! Customer already exists')
        elif self.name_entry.get() == '':
            window.error_message('Error! Name field cannot be empty')
        else:
            try:
                name = self.name_entry.get()
                
                # add new customer to excel doc
                wb = load_workbook(PATH + '\\Resources\\Files\\GTC Customer List.xlsx')
                ws = wb['Sheet1'] 
                max_row = ws.max_row + 1

                ws.cell(column=1, row=max_row, value=self.name_entry.get())
                ws.cell(column=3, row=max_row, value=self.address_entry.get())
                ws.cell(column=5, row=max_row, value=self.state_entry.get())
                ws.cell(column=4, row=max_row, value=self.city_entry.get())
                ws.cell(column=6, row=max_row, value=self.postcode_entry.get())
                ws.cell(column=7, row=max_row, value=self.phone_entry.get())
                ws.cell(column=8, row=max_row, value=self.email_entry.get())

                wb.save(PATH + '\\Resources\\Files\\GTC Customer List.xlsx')
                wb.close()

                self.cus_names.append(name)

                window.confirm_message(f'Successfully added {name} to the customer list')
            except:
                window.error_message('Error! Customer List Not Found')
    
    # clears all entry fields for customer data
    def clear_cus_entries(self):
        self.name_entry.delete(0, END)
        self.address_entry.delete(0, END)
        self.state_entry.delete(0, END)
        self.city_entry.delete(0, END)
        self.postcode_entry.delete(0, END)
        self.phone_entry.delete(0, END)
        self.email_entry.delete(0, END)
    
    # delete default search entry text when clicked
    def clicked(self, event=None):
        if self.search_entry.get() == 'Search for a Customer':
            self.search_entry.delete(0, END)
        
    # check if search entry matches any customer names and update listbox
    def check_listbox(self, event=None):
        typed = self.search_entry.get()
        self.search_entry.configure(foreground='black')

        if typed == '':
            data = []
        else:
            data = []
            for name in self.cus_names:
                if typed.lower() in name.lower():
                    data.append(name)
        
        self.update_listbox(data)
    
    # update suggestions based on search entry
    def update_listbox(self, data):
        self.listbox.delete(0, END)
        for name in data:
            self.listbox.insert(END, name)

    # autofill entry and customer information based on selection
    def autofill(self, event=None):
        try:
            self.search_entry.delete(0, END)
            self.search_entry.insert(0, self.listbox.get(self.listbox.curselection()))
            self.update_listbox([])
        except:
            self.search_entry.configure(foreground='grey')
            self.search_entry.insert(END, 'Search for a Customer')
        
        if self.search_entry.get() != 'Search for a Customer':
            try:
                # autofill customer information
                self.clear_cus_entries()
                row = self.cus_names.index(self.search_entry.get()) + 2

                wb = load_workbook(PATH + '\\Resources\\Files\\GTC Customer List.xlsx')
                ws = wb['Sheet1']  
                # confirming there is a value in the cell, does not like empty cells
                if ws.cell(row=row, column=1).value:
                    self.name_entry.insert(0, ws.cell(row=row, column=1).value)
                if ws.cell(row=row, column=3).value:
                    self.address_entry.insert(0, ws.cell(row=row, column=3).value)
                if ws.cell(row=row, column=5).value:
                    self.state_entry.insert(0, ws.cell(row=row, column=5).value)
                if ws.cell(row=row, column=4).value:
                    self.city_entry.insert(0, ws.cell(row=row, column=4).value)
                if ws.cell(row=row, column=6).value:
                    self.postcode_entry.insert(0, ws.cell(row=row, column=6).value)
                if ws.cell(row=row, column=7).value:
                    self.phone_entry.insert(0, ws.cell(row=row, column=7).value)
                if ws.cell(row=row, column=8).value:
                    self.email_entry.insert(0, ws.cell(row=row, column=8).value)

                wb.close()
            except:
                window.error_message('Error! Customer List Not Found')


    # creates all customer entry fields and labels
    def create_entries(self, frame):
        self.name_text = Label(frame, text='Customer Name', font=FONT, bg='white')
        self.name_text.grid(row=2, column=0, padx=20, pady=(5, 0), sticky=W)
        self.image35 = PhotoImage(file=PATH + '\\Resources\\Images\\entry_36.png')
        self.name_label = Label(frame, image=self.image35, border=0)
        self.name_label.grid(row=3, column=0, padx=18, pady=0, sticky=W)
        self.name_entry = Entry(frame, width=36, border=0, font=FONT, fg=ENTRY_COLOUR)
        self.name_entry.grid(row=3, column=0, padx=(27,0), pady=0, sticky=W)

        self.address_text = Label(frame, text='Address', font=FONT, bg='white')
        self.address_text.grid(row=4, column=0, padx=20, pady=(5, 0), sticky=W)
        self.address_label = Label(frame, image=self.image35, border=0)
        self.address_label.grid(row=5, column=0, padx=18, pady=0, sticky=W)
        self.address_entry = Entry(frame, width=36, border=0, font=FONT, fg=ENTRY_COLOUR)
        self.address_entry.grid(row=5, column=0, padx=(27,0), pady=0, sticky=W)

        self.state_text = Label(frame, text='State', font=FONT, bg='white')
        self.state_text.grid(row=6, column=0, padx=(229, 0), pady=(5, 0), sticky=W)
        self.image10 = PhotoImage(file=PATH + '\\Resources\\Images\\entry_10.png')
        self.state_label = Label(frame, image=self.image10, border=0)
        self.state_label.grid(row=7, column=0, padx=(227, 0), pady=0, sticky=W)
        self.state_entry = Entry(frame, width=10, border=0, font=FONT, fg=ENTRY_COLOUR)
        self.state_entry.grid(row=7, column=0, padx=(236,0), pady=0, sticky=W)

        self.city_text = Label(frame, text='City', font=FONT, bg='white')
        self.city_text.grid(row=6, column=0, padx=20, pady=(5, 0), sticky=W)
        self.image20 = PhotoImage(file=PATH + '\\Resources\\Images\\entry_20.png')
        self.city_label = Label(frame, image=self.image20, border=0)
        self.city_label.grid(row=7, column=0, padx=18, pady=0, sticky=W)
        self.city_entry = Entry(frame, width=20, border=0, font=FONT, fg=ENTRY_COLOUR)
        self.city_entry.grid(row=7, column=0, padx=(27,0), pady=0, sticky=W)

        self.postcode_text = Label(frame, text='Postcode', font=FONT, bg='white')
        self.postcode_text.grid(row=8, column=0, padx=(229, 0), pady=(5, 0), sticky=W)
        self.postcode_label = Label(frame, image=self.image10, border=0)
        self.postcode_label.grid(row=9, column=0, padx=(227, 0), pady=0, sticky=W)
        self.postcode_entry = Entry(frame, width=10, border=0, font=FONT, fg=ENTRY_COLOUR)
        self.postcode_entry.grid(row=9, column=0, padx=(236,0), pady=0, sticky=W)

        self.phone_text = Label(frame, text='Phone Number', font=FONT, bg='white')
        self.phone_text.grid(row=8, column=0, padx=20, pady=(5, 0), sticky=W)
        self.phone_label = Label(frame, image=self.image20, border=0)
        self.phone_label.grid(row=9, column=0, padx=18, pady=0, sticky=W)
        self.phone_entry = Entry(frame, width=10, border=0, font=FONT, fg=ENTRY_COLOUR)
        self.phone_entry.grid(row=9, column=0, padx=(27,0), pady=0, sticky=W)

        self.email_text = Label(frame, text='Email Address', font=FONT, bg='white')
        self.email_text.grid(row=10, column=0, padx=20, pady=(5, 0), sticky=W)
        self.email_label = Label(frame, image=self.image35, border=0)
        self.email_label.grid(row=11, column=0, padx=18, pady=0, sticky=W)
        self.email_entry = Entry(frame, width=36, border=0, font=FONT, fg=ENTRY_COLOUR)
        self.email_entry.grid(row=11, column=0, padx=(27,0), pady=0, sticky=W)

if __name__ == "__main__":
    root = tk.Tk()
    root.geometry("1235x645")
    root.title("Geraldton Trophy Centre v5.0")
    root.configure(background='white')
    root.iconbitmap(PATH + '\\Resources\\Images\\logo.ico')

    window = Window(root)
    window.center(root)

    root.mainloop()
